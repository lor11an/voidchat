<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoidChat ‚Äî Anonymous Chat & Voice</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --bg: #0a0a0f;
    --bg2: #111118;
    --bg3: #1a1a24;
    --bg4: #22222e;
    --border: #2a2a3a;
    --accent: #7c6af7;
    --accent2: #a855f7;
    --accent-dim: rgba(124,106,247,0.15);
    --green: #22d3a0;
    --red: #f75a5a;
    --text: #e8e8f0;
    --text2: #9090aa;
    --text3: #5a5a72;
    --radius: 12px;
    --glow: 0 0 20px rgba(124,106,247,0.3);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    overflow: hidden;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse 80% 50% at 20% -10%, rgba(124,106,247,0.12) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 80% 110%, rgba(168,85,247,0.08) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  /* SIDEBAR */
  .sidebar {
    width: 240px;
    background: var(--bg2);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 1;
    flex-shrink: 0;
  }

  .sidebar-header {
    padding: 20px 16px 14px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-family: 'Space Mono', monospace;
    font-size: 18px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
  }

  .logo-sub {
    font-size: 11px;
    color: var(--text3);
    margin-top: 2px;
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.5px;
  }

  .section-label {
    font-size: 10px;
    font-weight: 600;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    padding: 14px 16px 6px;
  }

  .room-list {
    flex: 1;
    overflow-y: auto;
    padding: 0 8px;
  }

  .room-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--text2);
    font-size: 14px;
    position: relative;
  }

  .room-item:hover { background: var(--bg3); color: var(--text); }
  .room-item.active { background: var(--accent-dim); color: var(--accent); }
  .room-item .room-icon { font-size: 14px; opacity: 0.7; width: 16px; text-align: center; }
  .room-item .unread {
    margin-left: auto;
    background: var(--accent);
    color: white;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
  }

  .voice-rooms { padding: 0 8px; }

  .voice-room-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--text2);
    font-size: 14px;
  }

  .voice-room-item:hover { background: var(--bg3); color: var(--text); }
  .voice-room-item.in-call { color: var(--green); background: rgba(34,211,160,0.08); }

  .voice-members {
    padding-left: 28px;
    margin-top: 2px;
  }

  .voice-member {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    font-size: 12px;
    color: var(--text3);
  }

  .voice-member .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--green);
    flex-shrink: 0;
  }

  .user-panel {
    border-top: 1px solid var(--border);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .avatar {
    width: 34px; height: 34px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 700;
    font-family: 'Space Mono', monospace;
    flex-shrink: 0;
    color: white;
  }

  .user-info { flex: 1; min-width: 0; }
  .user-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .user-status { font-size: 11px; color: var(--text3); }

  /* MAIN */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    z-index: 1;
    min-width: 0;
  }

  .chat-header {
    padding: 0 20px;
    height: 52px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(10,10,15,0.7);
    backdrop-filter: blur(10px);
    flex-shrink: 0;
  }

  .chat-header .channel-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
  }

  .chat-header .channel-icon { color: var(--text3); font-size: 16px; }
  .chat-header .divider { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }
  .chat-header .channel-desc { font-size: 13px; color: var(--text3); }

  .header-actions { margin-left: auto; display: flex; gap: 8px; }

  .btn-icon {
    width: 32px; height: 32px;
    border-radius: 8px;
    border: none;
    background: transparent;
    color: var(--text2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.15s;
  }
  .btn-icon:hover { background: var(--bg3); color: var(--text); }
  .btn-icon.active { background: var(--accent-dim); color: var(--accent); }

  /* VOICE BAR */
  .voice-bar {
    background: rgba(34,211,160,0.08);
    border-bottom: 1px solid rgba(34,211,160,0.2);
    padding: 8px 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    flex-shrink: 0;
  }

  .voice-bar.hidden { display: none; }
  .voice-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(1.3)} }
  .voice-bar-text { color: var(--green); font-weight: 500; }
  .voice-bar-room { color: var(--text2); }
  .voice-bar-actions { margin-left: auto; display: flex; gap: 6px; }

  .btn-sm {
    padding: 4px 12px;
    border-radius: 6px;
    border: none;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    font-family: 'DM Sans', sans-serif;
  }
  .btn-danger { background: rgba(247,90,90,0.15); color: var(--red); }
  .btn-danger:hover { background: rgba(247,90,90,0.25); }
  .btn-mute { background: var(--bg3); color: var(--text2); }
  .btn-mute:hover { background: var(--bg4); color: var(--text); }
  .btn-mute.muted { background: rgba(247,90,90,0.1); color: var(--red); }

  /* MESSAGES */
  .messages-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .messages-area::-webkit-scrollbar { width: 4px; }
  .messages-area::-webkit-scrollbar-track { background: transparent; }
  .messages-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .day-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 16px 0 8px;
  }
  .day-divider::before, .day-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .day-divider span { font-size: 11px; color: var(--text3); font-weight: 600; white-space: nowrap; }

  .message {
    display: flex;
    gap: 12px;
    padding: 4px 8px;
    border-radius: 8px;
    transition: background 0.1s;
    align-items: flex-start;
  }
  .message:hover { background: rgba(255,255,255,0.02); }
  .message.grouped { padding-top: 1px; padding-bottom: 1px; }
  .message.grouped .msg-avatar { visibility: hidden; height: 0; margin-top: 0; }
  .message.grouped .msg-header { display: none; }
  .message.grouped .msg-body { margin-top: 0; }

  .msg-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 700;
    font-family: 'Space Mono', monospace;
    flex-shrink: 0;
    color: white;
    margin-top: 2px;
  }

  .msg-content { flex: 1; min-width: 0; }
  .msg-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px; }
  .msg-name { font-size: 14px; font-weight: 600; }
  .msg-name.self { color: var(--accent); }
  .msg-time { font-size: 11px; color: var(--text3); font-family: 'Space Mono', monospace; }
  .msg-body { font-size: 14px; line-height: 1.5; color: var(--text); word-break: break-word; }

  .system-msg {
    text-align: center;
    font-size: 12px;
    color: var(--text3);
    padding: 6px;
    font-style: italic;
  }

  .msg-avatar.you { background: linear-gradient(135deg, var(--accent), var(--accent2)); }

  /* INPUT AREA */
  .input-area {
    padding: 0 20px 20px;
    flex-shrink: 0;
  }

  .input-box {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0 16px;
    transition: border-color 0.2s;
  }
  .input-box:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,106,247,0.1); }

  .input-box input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    padding: 14px 0;
    font-size: 14px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
  }
  .input-box input::placeholder { color: var(--text3); }

  .send-btn {
    width: 32px; height: 32px;
    border-radius: 8px;
    border: none;
    background: var(--accent);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .send-btn:hover { background: var(--accent2); transform: scale(1.05); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* VOICE MODAL */
  .voice-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .voice-modal.visible { opacity: 1; pointer-events: all; }

  .voice-modal-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 32px;
    width: 360px;
    text-align: center;
    box-shadow: 0 32px 80px rgba(0,0,0,0.6), var(--glow);
    transform: scale(0.95);
    transition: transform 0.2s;
  }
  .voice-modal.visible .voice-modal-card { transform: scale(1); }

  .voice-modal-title {
    font-family: 'Space Mono', monospace;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .voice-modal-sub { font-size: 13px; color: var(--text3); margin-bottom: 24px; }

  .voice-wave {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    height: 48px;
    margin-bottom: 24px;
  }
  .wave-bar {
    width: 4px;
    border-radius: 4px;
    background: var(--accent);
    animation: wave 1.2s ease-in-out infinite;
    opacity: 0.4;
  }
  .wave-bar.active { opacity: 1; }
  @keyframes wave {
    0%,100%{height:8px} 50%{height:32px}
  }
  .wave-bar:nth-child(1){animation-delay:0s}
  .wave-bar:nth-child(2){animation-delay:0.1s}
  .wave-bar:nth-child(3){animation-delay:0.2s}
  .wave-bar:nth-child(4){animation-delay:0.3s}
  .wave-bar:nth-child(5){animation-delay:0.4s}
  .wave-bar:nth-child(6){animation-delay:0.3s}
  .wave-bar:nth-child(7){animation-delay:0.2s}
  .wave-bar:nth-child(8){animation-delay:0.1s}
  .wave-bar:nth-child(9){animation-delay:0s}

  .voice-participants {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    margin-bottom: 24px;
  }

  .participant-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 30px;
    padding: 6px 12px 6px 6px;
    font-size: 13px;
  }
  .participant-chip .p-avatar {
    width: 26px; height: 26px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: white;
    font-family: 'Space Mono', monospace;
  }
  .participant-chip .speaking { animation: speakGlow 0.5s ease-in-out infinite alternate; }
  @keyframes speakGlow {
    from { box-shadow: 0 0 0 0 rgba(34,211,160,0); }
    to { box-shadow: 0 0 0 3px rgba(34,211,160,0.5); }
  }

  .voice-actions { display: flex; gap: 12px; justify-content: center; }

  .btn-voice {
    width: 52px; height: 52px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
  }
  .btn-voice.mute-btn { background: var(--bg3); color: var(--text2); }
  .btn-voice.mute-btn:hover { background: var(--bg4); }
  .btn-voice.mute-btn.muted { background: rgba(247,90,90,0.15); color: var(--red); }
  .btn-voice.end-btn { background: var(--red); color: white; }
  .btn-voice.end-btn:hover { transform: scale(1.1); background: #ff4444; }

  .voice-status { font-size: 12px; color: var(--text3); margin-top: 8px; }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 20px;
    border-radius: 30px;
    font-size: 13px;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    z-index: 200;
    white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* JOIN MODAL */
  .join-modal {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }

  .join-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 40px;
    width: 380px;
    text-align: center;
    box-shadow: 0 32px 80px rgba(0,0,0,0.6), var(--glow);
  }

  .join-logo {
    font-family: 'Space Mono', monospace;
    font-size: 32px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
  }

  .join-tagline { font-size: 14px; color: var(--text3); margin-bottom: 32px; }

  .join-input {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    font-size: 14px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    outline: none;
    margin-bottom: 10px;
    transition: border-color 0.2s;
    text-align: center;
  }
  .join-input:focus { border-color: var(--accent); }
  .join-input-label { font-size: 12px; color: var(--text3); margin-bottom: 8px; display: block; }

  .join-note { font-size: 11px; color: var(--text3); margin-top: 6px; margin-bottom: 24px; }

  .btn-primary {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
  }
  .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(124,106,247,0.3); }

  .random-name-btn {
    font-size: 12px;
    color: var(--accent);
    background: none;
    border: none;
    cursor: pointer;
    margin-top: 6px;
    font-family: 'DM Sans', sans-serif;
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  audio { display: none; }

  /* ROOMS PANEL */
  #rooms-panel { flex: 1; overflow-y: auto; }

  .add-room-btn {
    margin: 4px 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 10px;
    border-radius: 8px;
    border: 1px dashed var(--border);
    background: transparent;
    color: var(--text3);
    font-size: 13px;
    cursor: pointer;
    width: calc(100% - 16px);
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
  }
  .add-room-btn:hover { border-color: var(--accent); color: var(--accent); }

  .typing-indicator {
    display: flex; align-items: center; gap: 4px;
    padding: 6px 8px 0 56px;
    font-size: 12px;
    color: var(--text3);
    font-style: italic;
    min-height: 22px;
  }
  .typing-dots span {
    display: inline-block;
    width: 4px; height: 4px;
    border-radius: 50%;
    background: var(--text3);
    margin: 0 1px;
    animation: typingBounce 1.2s infinite;
  }
  .typing-dots span:nth-child(2){animation-delay:0.2s}
  .typing-dots span:nth-child(3){animation-delay:0.4s}
  @keyframes typingBounce { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-5px)} }

  @media (max-width: 600px) {
    .sidebar { width: 200px; }
    .join-card { width: 90vw; padding: 28px; }
  }
</style>
</head>
<body>

<!-- JOIN MODAL -->
<div class="join-modal" id="joinModal">
  <div class="join-card">
    <div class="join-logo">VoidChat</div>
    <div class="join-tagline">Anonymous. Ephemeral. Free.</div>
    <label class="join-input-label">Choose your anonymous name</label>
    <input type="text" class="join-input" id="nameInput" placeholder="e.g. SilentFox#2841" maxlength="30">
    <div>
      <button class="random-name-btn" onclick="randomizeName()">üé≤ Randomize name</button>
    </div>
    <div class="join-note">No account needed. Your identity exists only this session.</div>
    <label class="join-input-label">Enter a room code to join a specific room</label>
    <input type="text" class="join-input" id="roomCodeInput" placeholder="Leave blank for General" maxlength="20">
    <br><br>
    <button class="btn-primary" onclick="joinChat()">Enter the Void ‚Üí</button>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="sidebar-header">
    <div class="logo">VoidChat</div>
    <div class="logo-sub">anon ¬∑ ephemeral</div>
  </div>

  <div class="section-label">Text Channels</div>
  <div id="rooms-panel" class="room-list">
    <!-- populated by JS -->
  </div>
  <button class="add-room-btn" onclick="createRoom()">Ôºã Create Room</button>

  <div class="section-label">Voice Channels</div>
  <div class="voice-rooms" id="voiceRooms">
    <!-- populated by JS -->
  </div>

  <div class="user-panel">
    <div class="avatar you" id="sidebarAvatar">?</div>
    <div class="user-info">
      <div class="user-name" id="sidebarName">Anonymous</div>
      <div class="user-status">‚óè online</div>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="chat-header">
    <span class="channel-icon">#</span>
    <span class="channel-name" id="channelName">general</span>
    <div class="divider"></div>
    <span class="channel-desc" id="channelDesc">The void where voices echo</span>
    <div class="header-actions">
      <button class="btn-icon" title="Room Code" onclick="showRoomCode()">üîë</button>
      <button class="btn-icon active" title="Participants" onclick="showParticipants()">üë• <span id="onlineCount">1</span></button>
    </div>
  </div>

  <div class="voice-bar hidden" id="voiceBar">
    <div class="voice-indicator"></div>
    <span class="voice-bar-text">Voice Connected</span>
    <span class="voice-bar-room" id="voiceBarRoom"></span>
    <div class="voice-bar-actions">
      <button class="btn-sm btn-mute" id="voiceBarMute" onclick="toggleMute()">üé§ Mute</button>
      <button class="btn-sm btn-danger" onclick="leaveVoice()">‚úï Leave</button>
    </div>
  </div>

  <div class="messages-area" id="messagesArea">
    <div class="day-divider"><span>Today</span></div>
  </div>

  <div class="typing-indicator" id="typingIndicator"></div>

  <div class="input-area">
    <div class="input-box">
      <input type="text" id="messageInput" placeholder="Message #general" maxlength="500" 
        onkeydown="handleKey(event)" oninput="handleTyping()">
      <button class="send-btn" onclick="sendMessage()" id="sendBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      </button>
    </div>
  </div>
</div>

<!-- VOICE MODAL -->
<div class="voice-modal" id="voiceModal">
  <div class="voice-modal-card">
    <div class="voice-modal-title" id="voiceModalTitle">üéô Voice Channel</div>
    <div class="voice-modal-sub" id="voiceModalSub">Connected ‚Ä¢ 0 ms</div>
    <div class="voice-wave" id="voiceWave">
      <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
      <div class="wave-bar"></div><div class="wave-bar active"></div><div class="wave-bar"></div>
      <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
    </div>
    <div class="voice-participants" id="voiceParticipants"></div>
    <div class="voice-actions">
      <button class="btn-voice mute-btn" id="muteBtn" onclick="toggleMute()" title="Mute">üé§</button>
      <button class="btn-voice end-btn" onclick="leaveVoice()" title="Leave">üìµ</button>
    </div>
    <div class="voice-status" id="voiceStatus">Waiting for others to join‚Ä¶</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Hidden audio elements -->
<audio id="localAudio" muted autoplay></audio>
<audio id="remoteAudio" autoplay></audio>

<script>
// ==================== STATE ====================
let myName = '';
let myColor = '';
let currentRoom = 'general';
let rooms = {
  general: { messages: [], members: new Set() },
  random: { messages: [], members: new Set() },
  lounge: { messages: [], members: new Set() }
};
let voiceRooms = {
  'Chill Zone': { members: [] },
  'Late Night': { members: [] }
};
let currentVoiceRoom = null;
let isMuted = false;
let localStream = null;
let peerConnections = {};
let isInVoice = false;
let typingTimeout = null;
let typingUsers = new Set();
let messageCount = 0;
let unreadCounts = {};

const COLORS = [
  '#7c6af7','#a855f7','#22d3a0','#f75a91','#f7a822','#22b4f7','#f76a22','#d3f722'
];

const ADJECTIVES = ['Silent','Shadow','Ghost','Void','Echo','Dark','Neon','Crypto','Anon','Byte','Flux','Static'];
const NOUNS = ['Fox','Wolf','Raven','Phantom','Cipher','Specter','Ninja','Monk','Hawk','Viper','Storm','Node'];

function randomName() {
  const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
  const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
  const num = Math.floor(Math.random() * 9000) + 1000;
  return `${adj}${noun}#${num}`;
}

function randomizeName() {
  document.getElementById('nameInput').value = randomName();
}

// Pre-fill random name
document.getElementById('nameInput').value = randomName();

function joinChat() {
  const nameInput = document.getElementById('nameInput').value.trim();
  const roomCode = document.getElementById('roomCodeInput').value.trim().toLowerCase().replace(/\s+/g, '-') || 'general';
  
  if (!nameInput) { showToast('Please enter a name!'); return; }
  
  myName = nameInput;
  myColor = COLORS[Math.floor(Math.random() * COLORS.length)];
  
  // Setup room
  if (roomCode && !rooms[roomCode]) {
    rooms[roomCode] = { messages: [], members: new Set() };
  }
  currentRoom = roomCode || 'general';
  
  document.getElementById('joinModal').style.display = 'none';
  
  // Update UI
  document.getElementById('sidebarName').textContent = myName;
  document.getElementById('sidebarAvatar').textContent = myName.charAt(0).toUpperCase();
  document.getElementById('sidebarAvatar').style.background = myColor;
  document.getElementById('messageInput').placeholder = `Message #${currentRoom}`;
  
  renderRooms();
  renderVoiceRooms();
  addSystemMessage(`Welcome to VoidChat, ${myName}! You are anonymous here.`);
  addSystemMessage(`Share your room code to invite others: ${currentRoom.toUpperCase()}`);
  
  // Simulate some activity
  simulateActivity();
}

function renderRooms() {
  const panel = document.getElementById('rooms-panel');
  panel.innerHTML = '';
  Object.keys(rooms).forEach(room => {
    const unread = unreadCounts[room] || 0;
    const div = document.createElement('div');
    div.className = `room-item${room === currentRoom ? ' active' : ''}`;
    div.setAttribute('data-room', room);
    div.innerHTML = `
      <span class="room-icon">#</span>
      <span>${room}</span>
      ${unread && room !== currentRoom ? `<span class="unread">${unread}</span>` : ''}
    `;
    div.onclick = () => switchRoom(room);
    panel.appendChild(div);
  });
  
  document.getElementById('channelName').textContent = currentRoom;
  document.getElementById('messageInput').placeholder = `Message #${currentRoom}`;
}

function renderVoiceRooms() {
  const panel = document.getElementById('voiceRooms');
  panel.innerHTML = '';
  Object.keys(voiceRooms).forEach(vr => {
    const members = voiceRooms[vr].members;
    const inCall = currentVoiceRoom === vr;
    const div = document.createElement('div');
    div.innerHTML = `
      <div class="voice-room-item${inCall ? ' in-call' : ''}" onclick="joinVoiceRoom('${vr}')">
        <span>üîä</span>
        <span>${vr}</span>
        ${members.length > 0 ? `<span style="margin-left:auto;font-size:11px;color:var(--text3)">${members.length}</span>` : ''}
      </div>
      ${members.length > 0 ? `<div class="voice-members">${members.map(m => `<div class="voice-member"><div class="dot"></div>${m}</div>`).join('')}</div>` : ''}
    `;
    panel.appendChild(div);
  });
}

function switchRoom(room) {
  currentRoom = room;
  unreadCounts[room] = 0;
  renderRooms();
  
  const messagesArea = document.getElementById('messagesArea');
  messagesArea.innerHTML = '<div class="day-divider"><span>Today</span></div>';
  
  // Re-render messages for room
  (rooms[room].messages || []).forEach(msg => {
    renderMessageDOM(msg);
  });
  
  scrollToBottom();
}

function createRoom() {
  const name = prompt('Room name (no spaces):');
  if (!name) return;
  const roomName = name.toLowerCase().replace(/\s+/g, '-').slice(0, 20);
  if (rooms[roomName]) { showToast('Room already exists!'); return; }
  rooms[roomName] = { messages: [], members: new Set() };
  renderRooms();
  switchRoom(roomName);
  addSystemMessage(`Room #${roomName} created! Share the code: ${roomName.toUpperCase()}`);
}

// ==================== MESSAGES ====================
function getInitial(name) {
  return name.charAt(0).toUpperCase();
}

function formatTime(date) {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

let lastMessageUser = null;
let lastMessageTime = 0;

function addMessage(name, text, color, isSystem = false) {
  if (isSystem) {
    addSystemMessage(text);
    return;
  }
  
  const now = new Date();
  const msgObj = { name, text, color, time: now, id: ++messageCount };
  rooms[currentRoom].messages.push(msgObj);
  renderMessageDOM(msgObj);
  scrollToBottom();
}

function renderMessageDOM(msg) {
  const messagesArea = document.getElementById('messagesArea');
  const isSelf = msg.name === myName;
  const now = msg.time;
  const timeDiff = now - lastMessageTime;
  const grouped = (msg.name === lastMessageUser) && timeDiff < 300000;
  
  lastMessageUser = msg.name;
  lastMessageTime = now;
  
  const div = document.createElement('div');
  div.className = `message${grouped ? ' grouped' : ''}`;
  div.innerHTML = `
    <div class="msg-avatar${isSelf ? ' you' : ''}" style="background:${msg.color}">${getInitial(msg.name)}</div>
    <div class="msg-content">
      <div class="msg-header">
        <span class="msg-name${isSelf ? ' self' : ''}" style="${!isSelf ? `color:${msg.color}` : ''}">${msg.name}</span>
        <span class="msg-time">${formatTime(now)}</span>
      </div>
      <div class="msg-body">${escapeHTML(msg.text)}</div>
    </div>
  `;
  messagesArea.appendChild(div);
}

function addSystemMessage(text) {
  const messagesArea = document.getElementById('messagesArea');
  const div = document.createElement('div');
  div.className = 'system-msg';
  div.textContent = text;
  messagesArea.appendChild(div);
  scrollToBottom();
}

function escapeHTML(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function scrollToBottom() {
  const area = document.getElementById('messagesArea');
  area.scrollTop = area.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text || !myName) return;
  
  input.value = '';
  addMessage(myName, text, myColor);
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function handleTyping() {
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    document.getElementById('typingIndicator').innerHTML = '';
  }, 2000);
}

// ==================== VOICE ====================
async function joinVoiceRoom(roomName) {
  if (currentVoiceRoom === roomName) {
    // Show modal again
    document.getElementById('voiceModal').classList.add('visible');
    return;
  }
  
  if (currentVoiceRoom) {
    leaveVoice(false);
  }
  
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    document.getElementById('localAudio').srcObject = localStream;
    
    currentVoiceRoom = roomName;
    isInVoice = true;
    
    // Add self to voice room
    if (!voiceRooms[roomName]) voiceRooms[roomName] = { members: [] };
    voiceRooms[roomName].members.push(myName);
    
    // Update UI
    document.getElementById('voiceBar').classList.remove('hidden');
    document.getElementById('voiceBarRoom').textContent = `‚Äî ${roomName}`;
    document.getElementById('voiceModalTitle').textContent = `üéô ${roomName}`;
    document.getElementById('voiceModal').classList.add('visible');
    
    renderVoiceRooms();
    updateVoiceParticipants();
    
    addSystemMessage(`${myName} joined voice channel: ${roomName}`);
    
    // Simulate another user joining after 3 seconds
    setTimeout(() => {
      if (currentVoiceRoom === roomName) {
        const simUser = randomName();
        voiceRooms[roomName].members.push(simUser);
        renderVoiceRooms();
        updateVoiceParticipants();
        document.getElementById('voiceStatus').textContent = `${voiceRooms[roomName].members.length} people connected`;
        showToast(`${simUser} joined the voice channel`);
      }
    }, 3000);
    
    // Animate waveform based on audio
    startWaveformAnimation();
    
  } catch(err) {
    if (err.name === 'NotAllowedError') {
      showToast('Microphone access denied. Please allow mic access.');
    } else {
      showToast('Could not access microphone: ' + err.message);
    }
  }
}

function updateVoiceParticipants() {
  const container = document.getElementById('voiceParticipants');
  container.innerHTML = '';
  if (!currentVoiceRoom) return;
  
  const members = voiceRooms[currentVoiceRoom]?.members || [];
  members.forEach(m => {
    const isSelf = m === myName;
    const chip = document.createElement('div');
    chip.className = 'participant-chip';
    chip.innerHTML = `
      <div class="p-avatar${isSelf ? ' speaking' : ''}" style="background:${isSelf ? myColor : COLORS[Math.floor(Math.random()*COLORS.length)]}">${m.charAt(0).toUpperCase()}</div>
      <span>${m}${isSelf ? ' (you)' : ''}</span>
      ${isMuted && isSelf ? 'üîá' : ''}
    `;
    container.appendChild(chip);
  });
}

function leaveVoice(showMsg = true) {
  if (!currentVoiceRoom) return;
  
  const roomName = currentVoiceRoom;
  
  // Stop stream
  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
  }
  
  // Remove from voice room
  if (voiceRooms[roomName]) {
    voiceRooms[roomName].members = voiceRooms[roomName].members.filter(m => m !== myName);
  }
  
  currentVoiceRoom = null;
  isInVoice = false;
  isMuted = false;
  
  document.getElementById('voiceBar').classList.add('hidden');
  document.getElementById('voiceModal').classList.remove('visible');
  document.getElementById('muteBtn').textContent = 'üé§';
  document.getElementById('muteBtn').classList.remove('muted');
  document.getElementById('voiceBarMute').textContent = 'üé§ Mute';
  document.getElementById('voiceBarMute').classList.remove('muted');
  
  renderVoiceRooms();
  if (showMsg) addSystemMessage(`${myName} left voice channel: ${roomName}`);
}

function toggleMute() {
  if (!localStream) return;
  
  isMuted = !isMuted;
  localStream.getAudioTracks().forEach(track => track.enabled = !isMuted);
  
  const muteBtn = document.getElementById('muteBtn');
  const voiceBarMute = document.getElementById('voiceBarMute');
  
  if (isMuted) {
    muteBtn.textContent = 'üîá';
    muteBtn.classList.add('muted');
    voiceBarMute.textContent = 'üîá Unmute';
    voiceBarMute.classList.add('muted');
    showToast('Microphone muted');
  } else {
    muteBtn.textContent = 'üé§';
    muteBtn.classList.remove('muted');
    voiceBarMute.textContent = 'üé§ Mute';
    voiceBarMute.classList.remove('muted');
    showToast('Microphone unmuted');
  }
  
  updateVoiceParticipants();
}

let waveInterval = null;
function startWaveformAnimation() {
  if (waveInterval) clearInterval(waveInterval);
  const bars = document.querySelectorAll('.wave-bar');
  waveInterval = setInterval(() => {
    if (!isInVoice || isMuted) {
      bars.forEach(b => b.classList.remove('active'));
      return;
    }
    bars.forEach(b => {
      b.classList.toggle('active', Math.random() > 0.4);
    });
  }, 200);
}

// ==================== SIMULATION ====================
const BOT_NAMES = ['NeonPhantom#3821','SilentRaven#7732','VoidWalker#1029','EchoSpecter#5543'];
const BOT_COLORS = ['#22d3a0','#f75a91','#f7a822','#22b4f7'];
const BOT_MESSAGES = [
  'anyone here?',
  'this interface looks sick',
  'just found this, how does it work?',
  'lol it\'s actually working',
  'is the audio calling working for you guys?',
  'the anonymity is actually nice',
  'no account needed? based',
  'who else is lurking',
  'üôè',
  'this reminds me of early discord',
  'click the voice channel to call btw',
  'what\'s everyone up to',
  'void calls out...',
  'how do I create a room?',
  'tried the voice call, it works!',
  'the design is üî•'
];

function simulateActivity() {
  // Initial message after 2s
  setTimeout(() => {
    const bot = Math.floor(Math.random() * BOT_NAMES.length);
    addMessage(BOT_NAMES[bot], BOT_MESSAGES[0], BOT_COLORS[bot]);
    updateOnlineCount();
  }, 2000);
  
  // More messages
  let delay = 4000;
  for (let i = 1; i < 5; i++) {
    delay += Math.random() * 5000 + 2000;
    const d = delay;
    setTimeout(() => {
      if (!myName) return;
      const bot = Math.floor(Math.random() * BOT_NAMES.length);
      const msg = BOT_MESSAGES[Math.floor(Math.random() * BOT_MESSAGES.length)];
      
      // Show typing indicator first
      showTyping(BOT_NAMES[bot]);
      setTimeout(() => {
        hideTyping(BOT_NAMES[bot]);
        addMessage(BOT_NAMES[bot], msg, BOT_COLORS[bot]);
      }, 1500);
    }, d);
  }
  
  updateOnlineCount();
}

function showTyping(name) {
  typingUsers.add(name.split('#')[0]);
  renderTyping();
}

function hideTyping(name) {
  typingUsers.delete(name.split('#')[0]);
  renderTyping();
}

function renderTyping() {
  const el = document.getElementById('typingIndicator');
  if (typingUsers.size === 0) { el.innerHTML = ''; return; }
  const names = [...typingUsers].slice(0, 3).join(', ');
  const verb = typingUsers.size === 1 ? 'is' : 'are';
  el.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>&nbsp;${names} ${verb} typing‚Ä¶`;
}

function updateOnlineCount() {
  const count = Math.floor(Math.random() * 8) + 2;
  document.getElementById('onlineCount').textContent = count;
}

// ==================== UTILITY ====================
function showToast(msg, duration = 3000) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), duration);
}

function showRoomCode() {
  showToast(`Room code: ${currentRoom.toUpperCase()} ‚Äî Share with friends!`, 4000);
}

function showParticipants() {
  showToast(`${document.getElementById('onlineCount').textContent} anonymous users online`, 3000);
}

// Close voice modal on backdrop click
document.getElementById('voiceModal').addEventListener('click', function(e) {
  if (e.target === this) this.classList.remove('visible');
});

// Voice modal ping - update latency
setInterval(() => {
  if (isInVoice) {
    const ping = Math.floor(Math.random() * 30) + 10;
    document.getElementById('voiceModalSub').textContent = `Connected ‚Ä¢ ${ping} ms`;
  }
}, 2000);
</script>
</body>
</html>
